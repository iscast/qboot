<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="org.qboot.sys.dao.SysOperateLogDao">

	<resultMap id="SysOperateLogDtoResult" type="org.qboot.sys.dto.SysOperateLogDto">
		<result column="id" jdbcType="BIGINT" property="id" />
		<result column="log_id" jdbcType="BIGINT" property="logId" />
		<result column="uri_name" jdbcType="VARCHAR" property="uriName" />
		<result column="request_uri" jdbcType="VARCHAR" property="requestUri" />
		<result column="request_ip" jdbcType="VARCHAR" property="requestIP" />
		<result column="request_userid" jdbcType="VARCHAR" property="requestUserId" />
		<result column="request_date" jdbcType="TIMESTAMP" property="requestDate" />
		<result column="response_time" jdbcType="INTEGER" property="responseTime" />
		<result column="request_params" jdbcType="VARCHAR" property="requestParams" />
		<result column="response_params" jdbcType="VARCHAR" property="responseParams" />
	</resultMap>
	
	<sql id="common_columns">
		sl.log_id, ifnull(si.URI_NAME, sl.request_uri) as uri_name, sl.request_uri, sl.request_ip, sl.request_userid, sl.request_date, sl.response_time
	</sql>

	<insert id="insert" parameterType="org.qboot.sys.dto.SysOperateLogDto">
		INSERT INTO sys_operate_log 
		(log_id, request_uri, request_ip, request_userid, request_date, response_time, request_params, response_params)
		VALUES
		(#{logId, jdbcType=BIGINT},#{requestUri, jdbcType=VARCHAR}
		,#{requestIP, jdbcType=VARCHAR},#{requestUserId, jdbcType=VARCHAR},#{requestDate, jdbcType=TIMESTAMP}
		,#{responseTime, jdbcType=INTEGER},#{requestParams, jdbcType=VARCHAR},#{responseParams, jdbcType=VARCHAR})
	</insert>
	
	<insert id="batchInsert" parameterType="java.util.List">
		INSERT INTO sys_operate_log 
		(log_id, request_uri, request_ip, request_userid, request_date, response_time, request_params, response_params)
		VALUES
		<foreach collection ="list" item="item" separator =",">
		(#{item.logId, jdbcType=BIGINT},#{item.requestUri, jdbcType=VARCHAR}
		,#{item.requestIP, jdbcType=VARCHAR},#{item.requestUserId, jdbcType=VARCHAR},#{item.requestDate, jdbcType=TIMESTAMP}
		,#{item.responseTime, jdbcType=INTEGER},#{item.requestParams, jdbcType=VARCHAR}, #{item.responseParams, jdbcType=VARCHAR})
		</foreach >
	</insert>
    
    <select id="findList" parameterType="org.qboot.sys.dto.SysOperateLogDto" resultMap="SysOperateLogDtoResult">
        SELECT
        <include refid="common_columns" />
        FROM sys_operate_log as sl left join sys_operate_log_info as si on sl.log_id=si.log_id
        <where>
           <include refid="search_conditions" />
        </where>
        order by request_date desc
    </select>
    
    <select id="queryPageDetail" parameterType="org.qboot.sys.dto.SysOperateLogDto" resultMap="SysOperateLogDtoResult">
    	SELECT user_id, request_date, response_params FROM sys_operate_log
    	<where>
    		<if test="logId != null and logId > 0">
	           AND log_id=#{logId} 
	       </if>
	    	<if test="startDate != null">
	           AND request_date <![CDATA[>=]]> #{startDate}
	       </if>
	       <if test="endDate != null">
	           AND request_date <![CDATA[<]]> #{endDate}
	       </if>
    	</where>
    </select>
    
    
     <!-- 查询条件 -->
     <sql id = "search_conditions">
       <if test="startDate != null">
           AND request_date <![CDATA[>=]]> #{startDate}
       </if>
       <if test="endDate != null">
           AND request_date <![CDATA[<]]> #{endDate}
       </if>
       <if test="logId != null and logId > 0">
           AND log_id = #{logId}
       </if>
     </sql>
    
</mapper>   
